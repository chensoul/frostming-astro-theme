---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { themeConfig } from '../../theme/config';

export async function getStaticPaths() {
  const posts: CollectionEntry<'posts'>[] = await getCollection('posts');
  const tags = new Set<string>();
  for (const p of posts) {
    for (const t of p.data.tags || []) tags.add(t);
  }
  return Array.from(tags).map((t) => ({ params: { tag: t } }));
}
const tag = decodeURIComponent(Astro.params.tag!);
const posts: CollectionEntry<'posts'>[] = (await getCollection('posts'))
  .filter((p: CollectionEntry<'posts'>) => (p.data.tags || []).includes(tag))
  .sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => +b.data.pubDate - +a.data.pubDate);
---
<BaseLayout title={`标签：${tag} | ${themeConfig.siteName}`} canonical={`${themeConfig.siteUrl.replace(/\/$/, '')}/tags/${encodeURIComponent(tag)}/`}>
  <Header />
  <main class="py-12 tags-detail">
    <a href="/tags" class="mb-4 inline-flex items-center gap-2 text-sm text-gray-600 hover:text-black dark:text-gray-400 dark:hover:text-white transition-colors">
      <svg width="1em" height="1em" class="size-4" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="m10 19l-7-7l7-7l1.425 1.4L6.825 10H21v2H6.825l4.6 4.6z"/></svg>
      所有标签
    </a>
    <h1 class="mb-8 font-bold">标签: <span class="text-gray-500 dark:text-gray-400">{tag}</span></h1>
    <ul class="divide-y divide-gray-200 dark:divide-gray-800">
      {posts.map(({ data, slug }) => (
        <li class="py-6 first:pt-0">
          <article class="grid grid-cols-1 gap-2 sm:grid-cols-[120px_1fr] sm:gap-4 sm:items-baseline">
            <time datetime={data.pubDate.toISOString()} class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-mono whitespace-nowrap">
              {`${data.pubDate.getFullYear()}–${String(data.pubDate.getMonth() + 1).padStart(2, '0')}–${String(data.pubDate.getDate()).padStart(2, '0')}`}
            </time>
            <div class="flex flex-wrap items-center gap-2 sm:gap-3">
              <a href={`/posts/${String(data.pubDate.getFullYear())}/${String(data.pubDate.getMonth() + 1).padStart(2, '0')}/${String(data.pubDate.getDate()).padStart(2, '0')}/${slug}/`} class="post-title text-lg font-bold hover:opacity-70 transition-opacity">{data.title}</a>
              {data.tags?.length ? (
                <div class="flex flex-wrap gap-2">
                  {data.tags.map((t: string) => (
                    <a href={`/tags/${encodeURIComponent(t)}/`} class="inline-block rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 px-3 py-1 text-xs">
                      {t}
                    </a>
                  ))}
                </div>
              ) : null}
            </div>
          </article>
        </li>
      ))}
    </ul>
  </main>
</BaseLayout>
